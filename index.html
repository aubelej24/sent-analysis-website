import pandas as pd
import plotly.graph_objects as go

# Load the data from CSV
df = pd.read_excel('G:/My Drive/Graduate School/Dissertation/Study 2/analysis/datasets/processed_data.xlsx')

# Convert the datetime column to datetime format
df['datetime'] = pd.to_datetime(df['datetime'], format="%Y%m%d%H%M%S")

# Define a color map for news sources
color_map = {
    'antiwar.com': 'aqua',
    'bizpacreview.com': 'green',
    'breitbart.com': 'brown',
    'commondreams.org': 'coral',
    'crooksandliars.com': 'black',
    'dailycaller.com': 'burlywood',
    'dailysignal.com': 'cadetblue',
    'floppingaces.net': 'chartreuse',
    'frontpagemag.com': 'cornflowerblue',
    'gopusa.com': 'crimson',
    'hotair.com': 'cyan',
    'independentsentinel.com': 'darkblue',
    'investmentwatchblog.com': 'darkcyan',
    'legalinsurrection.com': 'darkgray',
    'lewrockwell.com': 'darkgreen',
    'libcom.org': 'darkmagenta',
    'lifenews.com': 'darkorange',
    'mykeystrokes.com': 'darkorchid',
    'nationofchange.org': 'darksalmon',
    'newrepublic.com': 'darkseagreen',
    'newsbusters.org': 'darkslateblue',
    'newsmax.com': 'darkturquoise',
    'nytimes.com': 'deeppink',
    'patriotpost.us': 'dodgerblue',
    'peoplesworld.org': 'firebrick',
    'personalliberty.com': 'forestgreen',
    'politicususa.com': 'lavender',
    'redstate.com': 'limegreen',
    'salon.com': 'magenta',
    'slate.com': 'navy',
    'theconservativetreehouse.com': 'orange',
    'thenation.com': 'orangered',
    'towleroad.com': 'palegreen',
    'washingtonpost.com': 'peachpuff',
    'watermarkonline.com': 'red',
    'wsws.org': 'tomato'

}

# Calculate the mean sentiment score for each month and news source
monthly_mean_df = df.groupby([pd.Grouper(key='datetime', freq='M'), 'news_source'])['sentimentscore'].mean().reset_index()
monthly_mean_df.rename(columns={'datetime': 'month'}, inplace=True)

# Create the figure
fig = go.Figure()

# Add scatter plot for each news source
for news_source in monthly_mean_df['news_source'].unique():
    news_source_data = monthly_mean_df[monthly_mean_df['news_source'] == news_source]
    color = color_map.get(news_source, 'black')
    fig.add_trace(go.Scatter(x=news_source_data['month'], y=news_source_data['sentimentscore'],
                             mode='markers', name=news_source, marker=dict(color=color)))

    # Add rolling trendline for each news source
    rolling_mean = news_source_data['sentimentscore'].rolling(window=3, min_periods=1).mean()
    fig.add_trace(go.Scatter(x=news_source_data['month'], y=rolling_mean, mode='lines',
                             name=f'{news_source} Trendline', line=dict(color=color)))

# Configure the layout
fig.update_layout(
    xaxis=dict(
        range=['2020-01-01', '2020-12-31'],
        tickformat='%b %Y',
        dtick='M1'
    ),
    xaxis_title='Date',
    yaxis_title='Mean Sentiment Score',
    title='Mean Sentiment Analysis by News Source (Monthly)'
)

# Show the graph
fig.show()
